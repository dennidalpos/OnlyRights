<Window x:Class="NtfsAudit.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="NTFS Audit" Height="720" Width="1200"
        FontFamily="Segoe UI, Microsoft YaHei UI, Microsoft JhengHei UI, Yu Gothic UI">
  <Window.Resources>
    <Style TargetType="TabItem">
      <Setter Property="HorizontalContentAlignment" Value="Stretch" />
      <Setter Property="VerticalContentAlignment" Value="Stretch" />
    </Style>
    <Style x:Key="RightsRowStyle" TargetType="DataGridRow">
      <Style.Triggers>
        <DataTrigger Binding="{Binding IsDisabled}" Value="True">
          <Setter Property="TextBlock.TextDecorations" Value="Strikethrough" />
          <Setter Property="Foreground" Value="#FF9E9E9E" />
        </DataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding IsCustomRights}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE6E6E6" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasRead}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE3F2FD" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasList}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE8F5E9" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasReadAndExecute}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE0F7FA" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasWrite}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFFFF9C4" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasModify}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFFFE0B2" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasFullControl}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFFFCDD2" />
        </MultiDataTrigger>
      </Style.Triggers>
    </Style>
  </Window.Resources>
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <Border Padding="12" BorderBrush="#DDDDDD" BorderThickness="0,0,0,1">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Border Grid.Row="0" BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,0,0,8" IsEnabled="{Binding IsNotScanning}">
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <Button Grid.Column="0" Margin="0,0,8,0" Padding="12,4" Content="Sfoglia..." Command="{Binding BrowseCommand}" />
            <TextBox Grid.Column="1" Height="26" VerticalAlignment="Center" Text="{Binding RootPath, UpdateSourceTrigger=PropertyChanged}" />
          </Grid>
        </Border>

        <Border Grid.Row="1" BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,0,0,8">
          <StackPanel Orientation="Horizontal">
            <Button Margin="0,0,8,0" Padding="12,4" Content="Start" Command="{Binding StartCommand}" IsEnabled="{Binding CanStart}" Background="#FF2E7D32" Foreground="White" />
            <Button Margin="0,0,8,0" Padding="12,4" Content="Stop" Command="{Binding StopCommand}" IsEnabled="{Binding CanStop}" Background="#FFC62828" Foreground="White" />
            <Button Margin="0,0,8,0" Padding="12,4" Content="Export" Command="{Binding ExportCommand}" IsEnabled="{Binding CanExport}" Background="#FF1565C0" Foreground="White" />
            <Button Margin="0,0,8,0" Padding="12,4" Content="Export Analisi" Command="{Binding ExportAnalysisCommand}" IsEnabled="{Binding CanExport}" Background="#FF1565C0" Foreground="White" />
            <Button Padding="12,4" Content="Import Analisi" Command="{Binding ImportAnalysisCommand}" IsEnabled="{Binding IsNotScanning}" Background="#FF616161" Foreground="White" />
          </StackPanel>
        </Border>

        <Grid Grid.Row="2" Margin="0,0,0,8">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" />
            <ColumnDefinition Width="*" />
          </Grid.ColumnDefinitions>
          <Border Grid.Column="0" BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,0,8,0" IsEnabled="{Binding IsNotScanning}">
            <WrapPanel VerticalAlignment="Center">
              <TextBlock Text="MaxDepth" VerticalAlignment="Center" Margin="0,0,6,0" />
              <TextBox Width="60" Height="24" Text="{Binding MaxDepth}" IsEnabled="{Binding IsMaxDepthEnabled}" Margin="0,0,12,0" />
              <CheckBox Content="Analizza tutte le sottocartelle" IsChecked="{Binding ScanAllDepths}" />
            </WrapPanel>
          </Border>
          <Border Grid.Column="1" BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" IsEnabled="{Binding IsNotScanning}">
            <WrapPanel VerticalAlignment="Center">
              <CheckBox Margin="0,0,12,0" Content="Includi permessi ereditati" IsChecked="{Binding IncludeInherited}" />
              <CheckBox Margin="0,0,12,0" Content="Risolvi identità (più lento)" IsChecked="{Binding ResolveIdentities}" />
              <CheckBox Margin="0,0,12,0" Content="Espandi gruppi annidati" IsChecked="{Binding ExpandGroups}" IsEnabled="{Binding IsExpandGroupsEnabled}" />
              <CheckBox Margin="0,0,12,0" Content="Usa PowerShell per AD" IsChecked="{Binding UsePowerShell}" />
              <CheckBox Margin="0,0,12,0" Content="Escludi utenti di servizio" IsChecked="{Binding ExcludeServiceAccounts}" />
              <CheckBox Content="Escludi utenti admin" IsChecked="{Binding ExcludeAdminAccounts}" />
            </WrapPanel>
          </Border>
        </Grid>

        <Border Grid.Row="3" BorderBrush="#DDDDDD" BorderThickness="1" Padding="8">
          <Grid>
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="Auto" />
              <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            <Border BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,0,8,0" IsEnabled="{Binding IsNotScanning}">
              <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <CheckBox Content="Export al termine" Margin="0,0,12,0" IsChecked="{Binding ExportOnComplete}" VerticalAlignment="Center" />
                <CheckBox Content="Colora per diritto" IsChecked="{Binding ColorizeRights}" VerticalAlignment="Center" />
              </StackPanel>
            </Border>
            <StackPanel Grid.Column="1" Margin="0,0,12,0" VerticalAlignment="Center" HorizontalAlignment="Left">
              <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                <Border Width="14" Height="14" Background="{Binding StatusBrush}" CornerRadius="2" Margin="0,0,6,0" />
                <TextBlock Text="{Binding StatusText}" FontWeight="SemiBold" VerticalAlignment="Center" />
              </StackPanel>
              <Border Background="{Binding CurrentPathBackground}" Padding="4" CornerRadius="4" Margin="0,0,0,6">
                <TextBlock Text="{Binding CurrentPathText}" TextTrimming="CharacterEllipsis" />
              </Border>
              <WrapPanel>
                <Border Background="#FFC8E6C9" Padding="4" CornerRadius="4" Margin="0,0,8,0">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Analizzate: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding ProcessedCount}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Background="#FFFFCDD2" Padding="4" CornerRadius="4" Margin="0,0,8,0">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Errori: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding ErrorCount}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Background="#FFE3F2FD" Padding="4" CornerRadius="4">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Tempo: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding ElapsedText}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
              </WrapPanel>
            </StackPanel>
          </Grid>
        </Border>
      </Grid>
    </Border>

    <Border Grid.Row="1" Padding="0" BorderBrush="#DDDDDD" BorderThickness="0,0,0,1" />

    <Grid Grid.Row="2">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="280" />
        <ColumnDefinition Width="*" />
      </Grid.ColumnDefinitions>
      <Border BorderBrush="#DDDDDD" BorderThickness="1" Padding="6" Margin="8,8,4,8">
        <TreeView ItemsSource="{Binding FolderTree}" SelectedItemChanged="TreeView_OnSelectedItemChanged" VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.VirtualizationMode="Recycling">
          <TreeView.ItemContainerStyle>
            <Style TargetType="TreeViewItem">
              <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
              <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
              <Setter Property="Background" Value="Transparent" />
              <Setter Property="Foreground" Value="#FF212121" />
              <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                  <Setter Property="Background" Value="#FFBBDEFB" />
                  <Setter Property="Foreground" Value="#FF0D47A1" />
                  <Setter Property="FontWeight" Value="SemiBold" />
                </Trigger>
              </Style.Triggers>
            </Style>
          </TreeView.ItemContainerStyle>
          <TreeView.ItemTemplate>
            <HierarchicalDataTemplate ItemsSource="{Binding Children}">
              <TextBlock Text="{Binding DisplayName}" />
            </HierarchicalDataTemplate>
          </TreeView.ItemTemplate>
        </TreeView>
      </Border>
      <Grid Grid.Column="1">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <Border BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="4,8,8,8">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <TextBlock FontWeight="Bold" Text="{Binding SelectedFolderPath}" Margin="0,0,0,8" />
            <TabControl Grid.Row="1" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Stretch" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
              <TabItem Header="Permessi Gruppi">
                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                  <ScrollViewer HorizontalAlignment="Stretch" VerticalAlignment="Stretch" HorizontalScrollBarVisibility="Visible" VerticalScrollBarVisibility="Visible" CanContentScroll="False">
                    <Grid MinWidth="800" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                      <DataGrid ItemsSource="{Binding GroupEntries}" AutoGenerateColumns="False" IsReadOnly="True" EnableRowVirtualization="True" MouseDoubleClick="GroupEntries_OnMouseDoubleClick" RowStyle="{StaticResource RightsRowStyle}" ScrollViewer.HorizontalScrollBarVisibility="Disabled" ScrollViewer.VerticalScrollBarVisibility="Disabled" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <DataGrid.Columns>
                          <DataGridTextColumn Header="Gruppo" Binding="{Binding PrincipalName}" />
                          <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" />
              <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" />
              <DataGridTextColumn Header="Diritti" Binding="{Binding RightsSummary}" />
              <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" />
              <DataGridCheckBoxColumn Header="Disabilitato" Binding="{Binding IsDisabled, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Full" Binding="{Binding HasFullControl, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Modify" Binding="{Binding HasModify, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="R&amp;E" Binding="{Binding HasReadAndExecute, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="List" Binding="{Binding HasList, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Read" Binding="{Binding HasRead, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Write" Binding="{Binding HasWrite, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Custom" Binding="{Binding IsCustomRights, Mode=OneWay}" />
                          <DataGridTextColumn Header="Inherited" Binding="{Binding IsInherited}" />
                          <DataGridTextColumn Header="Inheritance" Binding="{Binding InheritanceFlags}" />
                          <DataGridTextColumn Header="Propagation" Binding="{Binding PropagationFlags}" />
                        </DataGrid.Columns>
                      </DataGrid>
                    </Grid>
                  </ScrollViewer>
                </Grid>
              </TabItem>
              <TabItem Header="Permessi Utenti">
                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                  <ScrollViewer HorizontalAlignment="Stretch" VerticalAlignment="Stretch" HorizontalScrollBarVisibility="Visible" VerticalScrollBarVisibility="Visible" CanContentScroll="False">
                    <Grid MinWidth="800" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                      <DataGrid ItemsSource="{Binding UserEntries}" AutoGenerateColumns="False" IsReadOnly="True" EnableRowVirtualization="True" MouseDoubleClick="UserEntries_OnMouseDoubleClick" RowStyle="{StaticResource RightsRowStyle}" ScrollViewer.HorizontalScrollBarVisibility="Disabled" ScrollViewer.VerticalScrollBarVisibility="Disabled" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <DataGrid.Columns>
                          <DataGridTextColumn Header="Utente" Binding="{Binding PrincipalName}" />
                          <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" />
              <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" />
              <DataGridTextColumn Header="Diritti" Binding="{Binding RightsSummary}" />
              <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" />
              <DataGridCheckBoxColumn Header="Disabilitato" Binding="{Binding IsDisabled, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Full" Binding="{Binding HasFullControl, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Modify" Binding="{Binding HasModify, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="R&amp;E" Binding="{Binding HasReadAndExecute, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="List" Binding="{Binding HasList, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Read" Binding="{Binding HasRead, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Write" Binding="{Binding HasWrite, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Custom" Binding="{Binding IsCustomRights, Mode=OneWay}" />
                          <DataGridTextColumn Header="Inherited" Binding="{Binding IsInherited}" />
                          <DataGridTextColumn Header="Inheritance" Binding="{Binding InheritanceFlags}" />
                          <DataGridTextColumn Header="Propagation" Binding="{Binding PropagationFlags}" />
                        </DataGrid.Columns>
                      </DataGrid>
                    </Grid>
                  </ScrollViewer>
                </Grid>
              </TabItem>
              <TabItem Header="Dettaglio ACL">
                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                  <ScrollViewer HorizontalAlignment="Stretch" VerticalAlignment="Stretch" HorizontalScrollBarVisibility="Visible" VerticalScrollBarVisibility="Visible" CanContentScroll="False">
                    <Grid MinWidth="800" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                      <DataGrid ItemsSource="{Binding AllEntries}" AutoGenerateColumns="False" IsReadOnly="True" EnableRowVirtualization="True" RowStyle="{StaticResource RightsRowStyle}" ScrollViewer.HorizontalScrollBarVisibility="Disabled" ScrollViewer.VerticalScrollBarVisibility="Disabled" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <DataGrid.Columns>
                          <DataGridTextColumn Header="Principal" Binding="{Binding PrincipalName}" />
                          <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" />
                          <DataGridTextColumn Header="Tipo" Binding="{Binding PrincipalType}" />
              <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" />
              <DataGridTextColumn Header="Diritti" Binding="{Binding RightsSummary}" />
              <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" />
              <DataGridCheckBoxColumn Header="Disabilitato" Binding="{Binding IsDisabled, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Full" Binding="{Binding HasFullControl, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Modify" Binding="{Binding HasModify, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="R&amp;E" Binding="{Binding HasReadAndExecute, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="List" Binding="{Binding HasList, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Read" Binding="{Binding HasRead, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Write" Binding="{Binding HasWrite, Mode=OneWay}" />
              <DataGridCheckBoxColumn Header="Custom" Binding="{Binding IsCustomRights, Mode=OneWay}" />
                          <DataGridTextColumn Header="Inherited" Binding="{Binding IsInherited}" />
                          <DataGridTextColumn Header="Inheritance" Binding="{Binding InheritanceFlags}" />
                          <DataGridTextColumn Header="Propagation" Binding="{Binding PropagationFlags}" />
                        </DataGrid.Columns>
                      </DataGrid>
                    </Grid>
                  </ScrollViewer>
                </Grid>
              </TabItem>
              <TabItem Header="Errori">
                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                  <ScrollViewer HorizontalAlignment="Stretch" VerticalAlignment="Stretch" HorizontalScrollBarVisibility="Visible" VerticalScrollBarVisibility="Visible" CanContentScroll="False">
                    <Grid MinWidth="800" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                      <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                      </Grid.RowDefinitions>
                      <TextBox Margin="0,0,0,6" Text="{Binding ErrorFilter, UpdateSourceTrigger=PropertyChanged}" />
                      <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredErrors}" AutoGenerateColumns="False" IsReadOnly="True" EnableRowVirtualization="True" ScrollViewer.HorizontalScrollBarVisibility="Disabled" ScrollViewer.VerticalScrollBarVisibility="Disabled" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                        <DataGrid.Columns>
                          <DataGridTextColumn Header="Path" Binding="{Binding Path}" Width="*" />
                          <DataGridTextColumn Header="Tipo" Binding="{Binding ErrorType}" Width="160" />
                          <DataGridTextColumn Header="Messaggio" Binding="{Binding Message}" Width="*" />
                        </DataGrid.Columns>
                      </DataGrid>
                    </Grid>
                  </ScrollViewer>
                </Grid>
              </TabItem>
            </TabControl>
          </Grid>
        </Border>
      </Grid>
    </Grid>
  </Grid>
</Window>
