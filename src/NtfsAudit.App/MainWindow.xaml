<Window x:Class="NtfsAudit.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="NTFS Audit"
        Width="980"
        Height="640"
        MinWidth="800"
        MinHeight="480"
        FontFamily="Segoe UI, Microsoft YaHei UI, Microsoft JhengHei UI, Yu Gothic UI"
        Closing="MainWindow_OnClosing">
  <Window.Resources>
    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    <Style x:Key="RightsRowStyle" TargetType="DataGridRow">
      <Style.Triggers>
        <DataTrigger Binding="{Binding IsDisabled}" Value="True">
          <Setter Property="TextBlock.TextDecorations" Value="Strikethrough" />
          <Setter Property="Foreground" Value="#FF9E9E9E" />
        </DataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasRead}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE3F2FD" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasList}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE8F5E9" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasReadAndExecute}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE0F7FA" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasWrite}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFFFF9C4" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasModify}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFFFE0B2" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasFullControl}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFFFCDD2" />
        </MultiDataTrigger>
      </Style.Triggers>
    </Style>
    <DataTemplate x:Key="PermissionBadgesTemplate">
      <StackPanel Orientation="Horizontal">
        <Border Background="#FF1976D2" Padding="2,0" CornerRadius="2" Margin="0,0,4,0" Visibility="{Binding IsInherited, Converter={StaticResource BooleanToVisibilityConverter}}" ToolTip="Ereditato">
          <TextBlock Text="I" Foreground="White" FontSize="10" />
        </Border>
        <Border Background="#FFC62828" Padding="2,0" CornerRadius="2" Margin="0,0,4,0" Visibility="{Binding IsInheritanceDisabled, Converter={StaticResource BooleanToVisibilityConverter}}" ToolTip="Protetto (ereditarietà disabilitata)">
          <TextBlock Text="P" Foreground="White" FontSize="10" />
        </Border>
        <Border Background="#FF6A1B9A" Padding="2,0" CornerRadius="2" Margin="0,0,4,0" Visibility="{Binding IsExplicitDeny, Converter={StaticResource BooleanToVisibilityConverter}}" ToolTip="Deny esplicito">
          <TextBlock Text="D" Foreground="White" FontSize="10" />
        </Border>
      </StackPanel>
    </DataTemplate>
  </Window.Resources>
  <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
    <Grid x:Name="ContentGrid" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" IsEnabled="{Binding IsNotBusy}">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <Border Padding="12" BorderBrush="#DDDDDD" BorderThickness="0,0,0,1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
      <Grid>
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
          <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>
        <Border Grid.Row="0" BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,0,0,8" Visibility="{Binding IsNotViewerMode, Converter={StaticResource BooleanToVisibilityConverter}}">
          <StackPanel Orientation="Horizontal">
            <Button Margin="0,0,8,0" Padding="12,4" Content="Start" Command="{Binding StartCommand}" IsEnabled="{Binding CanStart}" Background="#FF2E7D32" Foreground="White" />
            <Button Margin="0,0,8,0" Padding="12,4" Content="Stop" Command="{Binding StopCommand}" IsEnabled="{Binding CanStop}" Background="#FFC62828" Foreground="White" />
            <Button Margin="0,0,8,0" Padding="12,4" Content="Export Excel" Command="{Binding ExportCommand}" IsEnabled="{Binding CanExport}" Background="#FF1565C0" Foreground="White" />
            <Button Margin="0,0,8,0" Padding="12,4" Content="Export HTML" Command="{Binding ExportHtmlCommand}" IsEnabled="{Binding CanExport}" Background="#FF1565C0" Foreground="White" />
            <Button Margin="0,0,8,0" Padding="12,4" Content="Export Analisi" Command="{Binding ExportAnalysisCommand}" IsEnabled="{Binding CanExport}" Background="#FF1565C0" Foreground="White" />
            <Button Padding="12,4" Content="Import Analisi" Command="{Binding ImportAnalysisCommand}" IsEnabled="{Binding IsNotScanning}" Background="#FF616161" Foreground="White" />
          </StackPanel>
        </Border>

        <Border Grid.Row="0" BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,0,0,8" Visibility="{Binding IsViewerMode, Converter={StaticResource BooleanToVisibilityConverter}}">
          <StackPanel Orientation="Horizontal">
            <Button Padding="12,4" Content="Import Analisi" Command="{Binding ImportAnalysisCommand}" IsEnabled="{Binding IsNotScanning}" Background="#FF616161" Foreground="White" />
          </StackPanel>
        </Border>

        <Border Grid.Row="1" Background="#FFFFF3CD" BorderBrush="#FFFFEEBA" BorderThickness="1" CornerRadius="10" Padding="6,2" Margin="0,0,0,8"
                HorizontalAlignment="Left"
                Visibility="{Binding IsNotElevated, Converter={StaticResource BooleanToVisibilityConverter}}">
          <TextBlock Text="Non amministratore"
                     Foreground="#FF856404"
                     FontWeight="SemiBold" />
        </Border>

        <Grid Grid.Row="2" Margin="0,0,0,6" Visibility="{Binding IsNotViewerMode, Converter={StaticResource BooleanToVisibilityConverter}}">
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300" />
            <ColumnDefinition Width="300" />
            <ColumnDefinition Width="260" />
          </Grid.ColumnDefinitions>
          <GroupBox Grid.Column="0" Header="Scansione" BorderBrush="#DDDDDD" BorderThickness="1" Padding="6" Margin="0,0,6,0" IsEnabled="{Binding IsScanConfigEnabled}">
            <Grid>
              <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
              </Grid.RowDefinitions>
              <Grid Grid.Row="0" Margin="0,0,0,8">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Button Grid.Column="0" Margin="0,0,8,0" Padding="10,4" Content="Sfoglia..." Command="{Binding BrowseCommand}" />
                <TextBox Grid.Column="1" Height="26" VerticalAlignment="Center" MinWidth="160" Text="{Binding RootPath, UpdateSourceTrigger=PropertyChanged}" />
              </Grid>
              <Grid Grid.Row="1" Margin="0,0,0,6" Visibility="{Binding HasDfsTargets, Converter={StaticResource BooleanToVisibilityConverter}}">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Target DFS" VerticalAlignment="Center" Margin="0,0,6,0" />
                <ComboBox Grid.Column="1"
                          Height="24"
                          Background="{Binding DfsTargetBackground}"
                          ItemsSource="{Binding DfsTargets}"
                          SelectedItem="{Binding SelectedDfsTarget, UpdateSourceTrigger=PropertyChanged}" />
              </Grid>
              <Grid Grid.Row="2" Margin="0,0,0,6">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="Auto" />
                  <ColumnDefinition Width="Auto" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Profondità" VerticalAlignment="Center" Margin="0,0,6,0" />
                <TextBox Grid.Column="1" Width="60" Height="24" Text="{Binding MaxDepth}" IsEnabled="{Binding IsMaxDepthEnabled}" Margin="0,0,12,0" />
                <CheckBox Grid.Column="2" Content="Analizza tutte le sottocartelle" IsChecked="{Binding ScanAllDepths}" />
              </Grid>
              <CheckBox Grid.Row="3" Content="Includi permessi ereditati" IsChecked="{Binding IncludeInherited}" />
            </Grid>
          </GroupBox>
          <GroupBox Grid.Column="1" Header="Identità" BorderBrush="#DDDDDD" BorderThickness="1" Padding="6" Margin="0,0,6,0" IsEnabled="{Binding IsScanConfigEnabled}">
            <StackPanel>
              <CheckBox Margin="0,0,0,6" Content="Risolvi identità (più lento)" IsChecked="{Binding ResolveIdentities}" />
              <CheckBox Margin="0,0,0,6" Content="Espandi gruppi annidati" IsChecked="{Binding ExpandGroups}" IsEnabled="{Binding IsExpandGroupsEnabled}" />
              <CheckBox Margin="0,0,0,6" Content="Usa PowerShell per AD" IsChecked="{Binding UsePowerShell}" IsEnabled="{Binding IsIdentityOptionsEnabled}" />
              <CheckBox Margin="0,0,0,6" Content="Escludi utenti di servizio" IsChecked="{Binding ExcludeServiceAccounts}" IsEnabled="{Binding IsIdentityOptionsEnabled}" />
              <CheckBox Content="Escludi utenti admin" IsChecked="{Binding ExcludeAdminAccounts}" IsEnabled="{Binding IsIdentityOptionsEnabled}" />
            </StackPanel>
          </GroupBox>
          <GroupBox Grid.Column="2" Header="Audit avanzato" BorderBrush="#DDDDDD" BorderThickness="1" Padding="6" IsEnabled="{Binding IsScanConfigEnabled}">
            <StackPanel>
              <CheckBox Margin="0,0,0,6" Content="Abilita audit avanzato" IsChecked="{Binding EnableAdvancedAudit}" />
              <StackPanel IsEnabled="{Binding IsAdvancedAuditEnabled}">
                <CheckBox Margin="0,0,0,6" Content="Calcola Effective Access" IsChecked="{Binding ComputeEffectiveAccess}" />
                <CheckBox Margin="0,0,0,6" Content="Leggi permessi Share (SMB)" IsChecked="{Binding IncludeSharePermissions}" />
                <CheckBox Margin="0,0,0,6" Content="Scansiona file" IsChecked="{Binding IncludeFiles}" />
                <CheckBox Margin="0,0,0,6" Content="Leggi Owner e SACL" IsChecked="{Binding ReadOwnerAndSacl}" />
                <CheckBox Content="Confronta con baseline/policy attese" IsChecked="{Binding CompareBaseline}" />
              </StackPanel>
            </StackPanel>
          </GroupBox>
        </Grid>

        <Border Grid.Row="3" BorderBrush="#DDDDDD" BorderThickness="1" Padding="6" Visibility="{Binding IsNotViewerMode, Converter={StaticResource BooleanToVisibilityConverter}}">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>
            <TextBlock Grid.Row="0" Text="Stato scansione" FontWeight="SemiBold" Margin="0,0,0,6" />
            <StackPanel Grid.Row="1" Margin="0,0,12,0" VerticalAlignment="Center" HorizontalAlignment="Left">
              <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                <Border Width="14" Height="14" Background="{Binding StatusBrush}" CornerRadius="2" Margin="0,0,6,0" />
                <TextBlock Text="{Binding StatusText}" FontWeight="SemiBold" VerticalAlignment="Center" />
              </StackPanel>
              <Border Background="{Binding CurrentPathBackground}" Padding="4" CornerRadius="4" Margin="0,0,0,6">
                <TextBlock Text="{Binding CurrentPathText}" TextTrimming="CharacterEllipsis" />
              </Border>
              <WrapPanel>
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Analizzate: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding ProcessedCount}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Errori: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding ErrorCount}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Tempo: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding ElapsedText}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
              </WrapPanel>
              <WrapPanel Margin="0,6,0,0">
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Totale ACE: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding SummaryTotalEntries}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Rischio alto: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding SummaryHighRisk}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Rischio medio: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding SummaryMediumRisk}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Rischio basso: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding SummaryLowRisk}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Deny espliciti: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding SummaryDenyCount}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Everyone: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding SummaryEveryoneCount}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Authenticated Users: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding SummaryAuthUsersCount}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="File analizzati: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding SummaryFilesCount}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" Margin="0,0,8,0" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Baseline +: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding SummaryBaselineAdded}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
                <Border Padding="4" CornerRadius="4" BorderBrush="#DDDDDD" BorderThickness="1">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Baseline -: " VerticalAlignment="Center" />
                    <TextBlock Text="{Binding SummaryBaselineRemoved}" VerticalAlignment="Center" />
                  </StackPanel>
                </Border>
              </WrapPanel>
            </StackPanel>
          </Grid>
        </Border>
      </Grid>
    </Border>

    <Border Grid.Row="1" Padding="0" BorderBrush="#DDDDDD" BorderThickness="0,0,0,1" />

    <Grid Grid.Row="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="300" />
        <ColumnDefinition Width="6" />
        <ColumnDefinition Width="*" />
      </Grid.ColumnDefinitions>
        <Border BorderBrush="#DDDDDD" BorderThickness="1" Padding="6" Margin="6,6,4,6" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
          </Grid.RowDefinitions>
          <TextBlock Grid.Row="0" Text="Albero cartelle" FontWeight="SemiBold" Margin="2,0,0,6" />
            <StackPanel Grid.Row="1" Margin="0,0,0,6">
              <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                <Button Margin="0,0,6,0" Padding="8,2" Content="Espandi" IsEnabled="{Binding HasScanResult}" Click="ExpandTree_Click" />
                <Button Padding="8,2" Content="Comprimi" IsEnabled="{Binding HasScanResult}" Click="CollapseTree_Click" />
              </StackPanel>
            <StackPanel>
              <TextBlock Text="Legenda:" FontWeight="SemiBold" Margin="0,0,0,4" />
              <WrapPanel>
                <Border Background="#FFC62828" Padding="2,0" CornerRadius="2" Margin="0,0,6,4" ToolTip="Protetto (ereditarietà disabilitata)">
                  <TextBlock Text="P" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FF2E7D32" Padding="2,0" CornerRadius="2" Margin="0,0,6,4" ToolTip="ACE esplicite aggiunte">
                  <TextBlock Text="A" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FFF57C00" Padding="2,0" CornerRadius="2" Margin="0,0,6,4" ToolTip="ACE rimosse rispetto al padre">
                  <TextBlock Text="R" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FF6A1B9A" Padding="2,0" CornerRadius="2" Margin="0,0,6,4" ToolTip="Deny espliciti">
                  <TextBlock Text="D" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FF455A64" Padding="2,0" CornerRadius="2" Margin="0,0,6,4" ToolTip="Aggiunte vs baseline">
                  <TextBlock Text="BA" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FF78909C" Padding="2,0" CornerRadius="2" Margin="0,0,6,4" ToolTip="Rimozioni vs baseline">
                  <TextBlock Text="BR" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FF00897B" Padding="2,0" CornerRadius="2" Margin="0,0,6,4" ToolTip="ACE NTFS esplicite">
                  <TextBlock Text="N" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FF5E35B1" Padding="2,0" CornerRadius="2" Margin="0,0,6,4" ToolTip="Permessi Share presenti">
                  <TextBlock Text="S" Foreground="White" FontSize="10" />
                </Border>
              </WrapPanel>
            </StackPanel>
          </StackPanel>
          <TreeView x:Name="FolderTreeView" Grid.Row="2" ItemsSource="{Binding FolderTree}" SelectedItemChanged="TreeView_OnSelectedItemChanged" VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.VirtualizationMode="Recycling">
            <TreeView.ItemContainerStyle>
              <Style TargetType="TreeViewItem">
                <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
                <Setter Property="Background" Value="Transparent" />
                <Setter Property="Foreground" Value="#FF212121" />
                <Style.Triggers>
                  <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#FFBBDEFB" />
                    <Setter Property="Foreground" Value="#FF0D47A1" />
                    <Setter Property="FontWeight" Value="SemiBold" />
                  </Trigger>
                </Style.Triggers>
              </Style>
            </TreeView.ItemContainerStyle>
            <TreeView.ItemTemplate>
              <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                <StackPanel Orientation="Horizontal">
                  <TextBlock Text="{Binding DisplayName}" />
                  <Border Background="#FFC62828" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" Visibility="{Binding IsProtected, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="P" Foreground="White" FontSize="10" />
                  </Border>
                  <Border Background="#FF2E7D32" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" Visibility="{Binding HasExplicitAdded, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding ExplicitAddedLabel}" Foreground="White" FontSize="10" />
                  </Border>
                  <Border Background="#FFF57C00" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" Visibility="{Binding HasExplicitRemoved, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding ExplicitRemovedLabel}" Foreground="White" FontSize="10" />
                  </Border>
                  <Border Background="#FF6A1B9A" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" Visibility="{Binding HasDenyExplicit, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding DenyExplicitLabel}" Foreground="White" FontSize="10" />
                  </Border>
                  <Border Background="#FF455A64" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" Visibility="{Binding HasBaselineAdded, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding BaselineAddedLabel}" Foreground="White" FontSize="10" />
                  </Border>
                  <Border Background="#FF78909C" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" Visibility="{Binding HasBaselineRemoved, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding BaselineRemovedLabel}" Foreground="White" FontSize="10" />
                  </Border>
                  <Border Background="#FF00897B" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" Visibility="{Binding HasExplicitNtfs, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding ExplicitNtfsLabel}" Foreground="White" FontSize="10" />
                  </Border>
                  <Border Background="#FF5E35B1" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" Visibility="{Binding HasExplicitShare, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding ExplicitShareLabel}" Foreground="White" FontSize="10" />
                  </Border>
                </StackPanel>
              </HierarchicalDataTemplate>
            </TreeView.ItemTemplate>
          </TreeView>
        </Grid>
      </Border>
      <GridSplitter Grid.Column="1" Width="6" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="#FFE0E0E0" />
      <Grid Grid.Column="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <Border BorderBrush="#DDDDDD" BorderThickness="1" Padding="6" Margin="4,6,6,6" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <TextBlock Grid.Row="0" FontWeight="Bold" Text="{Binding SelectedFolderPath}" Margin="0,0,0,8" />
            <GroupBox Grid.Row="1" Header="Filtri risultati" BorderBrush="#DDDDDD" BorderThickness="1" Padding="6" Margin="0,0,0,6" IsEnabled="{Binding HasScanResult}">
              <StackPanel>
                <Grid Margin="0,0,0,6">
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                  </Grid.ColumnDefinitions>
                  <TextBlock Grid.Column="0" Text="Filtro ACL:" VerticalAlignment="Center" Margin="0,0,6,0" />
                  <TextBox Grid.Column="1" Height="24" MinWidth="220" Text="{Binding AclFilter, UpdateSourceTrigger=PropertyChanged}" />
                </Grid>
                <WrapPanel>
                  <CheckBox Margin="0,0,12,6" Content="Colora per diritto" IsChecked="{Binding ColorizeRights}" />
                  <CheckBox Margin="0,0,12,6" Content="Everyone" IsChecked="{Binding FilterEveryone}" />
                  <CheckBox Margin="0,0,12,6" Content="Authenticated Users" IsChecked="{Binding FilterAuthenticatedUsers}" />
                  <CheckBox Margin="0,0,12,6" Content="Solo Deny" IsChecked="{Binding FilterDenyOnly}" />
                  <CheckBox Margin="0,0,12,6" Content="Ereditarietà disabilitata" IsChecked="{Binding FilterInheritanceDisabled}" />
                </WrapPanel>
                <WrapPanel>
                  <Border Background="#FF1976D2" Padding="2,0" CornerRadius="2" Margin="0,0,6,0" ToolTip="Ereditato">
                    <TextBlock Text="I" Foreground="White" FontSize="10" />
                  </Border>
                  <Border Background="#FFC62828" Padding="2,0" CornerRadius="2" Margin="0,0,6,0" ToolTip="Protetto (ereditarietà disabilitata)">
                    <TextBlock Text="P" Foreground="White" FontSize="10" />
                  </Border>
                  <Border Background="#FF6A1B9A" Padding="2,0" CornerRadius="2" Margin="0,0,6,0" ToolTip="Deny esplicito">
                    <TextBlock Text="D" Foreground="White" FontSize="10" />
                  </Border>
                </WrapPanel>
              </StackPanel>
            </GroupBox>
            <TabControl Grid.Row="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
              <TabItem Header="Permessi Gruppi">
                <DataGrid ItemsSource="{Binding FilteredGroupEntries}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ColumnWidth="SizeToHeader"
                          MinColumnWidth="80"
                          MouseDoubleClick="GroupEntries_OnMouseDoubleClick"
                          RowStyle="{StaticResource RightsRowStyle}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                  <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Badge" CellTemplate="{StaticResource PermissionBadgesTemplate}" Width="70" />
                    <DataGridTextColumn Header="Risorsa" Binding="{Binding ResourceType}" Width="90" />
                    <DataGridTextColumn Header="Gruppo" Binding="{Binding PrincipalName}" Width="200" />
                    <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" Width="240" />
                    <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" Width="100" />
                    <DataGridTextColumn Header="Diritti" Binding="{Binding RightsSummary}" Width="160" />
                    <DataGridTextColumn Header="Effective Access" Binding="{Binding EffectiveRightsSummary}" Width="160" />
                    <DataGridTextColumn Header="Rischio" Binding="{Binding RiskLevel}" Width="90" />
                    <DataGridTextColumn Header="Owner" Binding="{Binding Owner}" Width="160" />
                    <DataGridTextColumn Header="SACL/Audit" Binding="{Binding AuditSummary}" Width="220" />
                    <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" Width="70" />
                    <DataGridCheckBoxColumn Header="Disabilitato" Binding="{Binding IsDisabled, Mode=OneWay}" Width="90" />
                    <DataGridCheckBoxColumn Header="Full" Binding="{Binding HasFullControl, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="Modify" Binding="{Binding HasModify, Mode=OneWay}" Width="70" />
                    <DataGridCheckBoxColumn Header="R&amp;E" Binding="{Binding HasReadAndExecute, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="List" Binding="{Binding HasList, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="Read" Binding="{Binding HasRead, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="Write" Binding="{Binding HasWrite, Mode=OneWay}" Width="60" />
                    <DataGridTextColumn Header="Inherited" Binding="{Binding IsInherited}" Width="90" />
                    <DataGridTextColumn Header="Inheritance" Binding="{Binding InheritanceFlags}" Width="120" />
                    <DataGridTextColumn Header="Propagation" Binding="{Binding PropagationFlags}" Width="120" />
                  </DataGrid.Columns>
                </DataGrid>
              </TabItem>
              <TabItem Header="Permessi Utenti">
                <DataGrid ItemsSource="{Binding FilteredUserEntries}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ColumnWidth="SizeToHeader"
                          MinColumnWidth="80"
                          MouseDoubleClick="UserEntries_OnMouseDoubleClick"
                          RowStyle="{StaticResource RightsRowStyle}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                  <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Badge" CellTemplate="{StaticResource PermissionBadgesTemplate}" Width="70" />
                    <DataGridTextColumn Header="Risorsa" Binding="{Binding ResourceType}" Width="90" />
                    <DataGridTextColumn Header="Utente" Binding="{Binding PrincipalName}" Width="200" />
                    <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" Width="240" />
                    <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" Width="100" />
                    <DataGridTextColumn Header="Diritti" Binding="{Binding RightsSummary}" Width="160" />
                    <DataGridTextColumn Header="Effective Access" Binding="{Binding EffectiveRightsSummary}" Width="160" />
                    <DataGridTextColumn Header="Rischio" Binding="{Binding RiskLevel}" Width="90" />
                    <DataGridTextColumn Header="Owner" Binding="{Binding Owner}" Width="160" />
                    <DataGridTextColumn Header="SACL/Audit" Binding="{Binding AuditSummary}" Width="220" />
                    <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" Width="70" />
                    <DataGridCheckBoxColumn Header="Disabilitato" Binding="{Binding IsDisabled, Mode=OneWay}" Width="90" />
                    <DataGridCheckBoxColumn Header="Full" Binding="{Binding HasFullControl, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="Modify" Binding="{Binding HasModify, Mode=OneWay}" Width="70" />
                    <DataGridCheckBoxColumn Header="R&amp;E" Binding="{Binding HasReadAndExecute, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="List" Binding="{Binding HasList, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="Read" Binding="{Binding HasRead, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="Write" Binding="{Binding HasWrite, Mode=OneWay}" Width="60" />
                    <DataGridTextColumn Header="Inherited" Binding="{Binding IsInherited}" Width="90" />
                    <DataGridTextColumn Header="Inheritance" Binding="{Binding InheritanceFlags}" Width="120" />
                    <DataGridTextColumn Header="Propagation" Binding="{Binding PropagationFlags}" Width="120" />
                  </DataGrid.Columns>
                </DataGrid>
              </TabItem>
              <TabItem Header="Dettaglio ACL">
                <DataGrid ItemsSource="{Binding FilteredAllEntries}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ColumnWidth="SizeToHeader"
                          MinColumnWidth="80"
                          RowStyle="{StaticResource RightsRowStyle}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                  <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Badge" CellTemplate="{StaticResource PermissionBadgesTemplate}" Width="70" />
                    <DataGridTextColumn Header="Risorsa" Binding="{Binding ResourceType}" Width="90" />
                    <DataGridTextColumn Header="Principal" Binding="{Binding PrincipalName}" Width="200" />
                    <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" Width="240" />
                    <DataGridTextColumn Header="Tipo" Binding="{Binding PrincipalType}" Width="100" />
                    <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" Width="100" />
                    <DataGridTextColumn Header="Diritti" Binding="{Binding RightsSummary}" Width="160" />
                    <DataGridTextColumn Header="Effective Access" Binding="{Binding EffectiveRightsSummary}" Width="160" />
                    <DataGridTextColumn Header="Rischio" Binding="{Binding RiskLevel}" Width="90" />
                    <DataGridTextColumn Header="Owner" Binding="{Binding Owner}" Width="160" />
                    <DataGridTextColumn Header="SACL/Audit" Binding="{Binding AuditSummary}" Width="220" />
                    <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" Width="70" />
                    <DataGridCheckBoxColumn Header="Disabilitato" Binding="{Binding IsDisabled, Mode=OneWay}" Width="90" />
                    <DataGridCheckBoxColumn Header="Full" Binding="{Binding HasFullControl, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="Modify" Binding="{Binding HasModify, Mode=OneWay}" Width="70" />
                    <DataGridCheckBoxColumn Header="R&amp;E" Binding="{Binding HasReadAndExecute, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="List" Binding="{Binding HasList, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="Read" Binding="{Binding HasRead, Mode=OneWay}" Width="60" />
                    <DataGridCheckBoxColumn Header="Write" Binding="{Binding HasWrite, Mode=OneWay}" Width="60" />
                    <DataGridTextColumn Header="Inherited" Binding="{Binding IsInherited}" Width="90" />
                    <DataGridTextColumn Header="Inheritance" Binding="{Binding InheritanceFlags}" Width="120" />
                    <DataGridTextColumn Header="Propagation" Binding="{Binding PropagationFlags}" Width="120" />
                  </DataGrid.Columns>
                </DataGrid>
              </TabItem>
              <TabItem Header="Share">
                <DataGrid ItemsSource="{Binding FilteredShareEntries}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ColumnWidth="SizeToHeader"
                          MinColumnWidth="80"
                          RowStyle="{StaticResource RightsRowStyle}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                  <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Badge" CellTemplate="{StaticResource PermissionBadgesTemplate}" Width="70" />
                    <DataGridTextColumn Header="Server" Binding="{Binding ShareServer}" Width="160" />
                    <DataGridTextColumn Header="Share" Binding="{Binding ShareName}" Width="160" />
                    <DataGridTextColumn Header="Principal" Binding="{Binding PrincipalName}" Width="200" />
                    <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" Width="240" />
                    <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" Width="100" />
                    <DataGridTextColumn Header="Diritti" Binding="{Binding RightsSummary}" Width="160" />
                    <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" Width="70" />
                    <DataGridTextColumn Header="Owner" Binding="{Binding Owner}" Width="160" />
                    <DataGridTextColumn Header="SACL/Audit" Binding="{Binding AuditSummary}" Width="220" />
                  </DataGrid.Columns>
                </DataGrid>
              </TabItem>
              <TabItem Header="Effective Access">
                <DataGrid ItemsSource="{Binding FilteredEffectiveEntries}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ColumnWidth="SizeToHeader"
                          MinColumnWidth="80"
                          RowStyle="{StaticResource RightsRowStyle}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                  <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Badge" CellTemplate="{StaticResource PermissionBadgesTemplate}" Width="70" />
                    <DataGridTextColumn Header="Principal" Binding="{Binding PrincipalName}" Width="200" />
                    <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" Width="240" />
                    <DataGridTextColumn Header="Effective" Binding="{Binding EffectiveRightsSummary}" Width="160" />
                    <DataGridTextColumn Header="NTFS Mask" Binding="{Binding NtfsRightsMask}" Width="120" />
                    <DataGridTextColumn Header="Share Mask" Binding="{Binding ShareRightsMask}" Width="120" />
                    <DataGridTextColumn Header="Owner" Binding="{Binding Owner}" Width="160" />
                    <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" Width="70" />
                  </DataGrid.Columns>
                </DataGrid>
              </TabItem>
              <TabItem Header="Errori">
                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                  <DataGrid ItemsSource="{Binding FilteredErrors}"
                            AutoGenerateColumns="False"
                            IsReadOnly="True"
                            EnableRowVirtualization="True"
                            EnableColumnVirtualization="True"
                            ScrollViewer.CanContentScroll="True"
                            ScrollViewer.HorizontalScrollBarVisibility="Auto"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            ColumnWidth="SizeToHeader"
                            MinColumnWidth="80"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch">
                    <DataGrid.Columns>
                      <DataGridTextColumn Header="Path" Binding="{Binding Path}" Width="360" />
                      <DataGridTextColumn Header="Tipo" Binding="{Binding ErrorType}" Width="160" />
                      <DataGridTextColumn Header="Messaggio" Binding="{Binding Message}" Width="420" />
                    </DataGrid.Columns>
                  </DataGrid>
                </Grid>
              </TabItem>
            </TabControl>
          </Grid>
        </Border>
      </Grid>
    </Grid>
    </Grid>
    <Border Background="#80000000" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
      <Border Background="White" Padding="24" CornerRadius="6" HorizontalAlignment="Center" VerticalAlignment="Center">
        <StackPanel>
          <TextBlock Text="Operazione in corso..." FontWeight="SemiBold" Margin="0,0,0,12" HorizontalAlignment="Center" />
          <ProgressBar Width="240" Height="16" IsIndeterminate="True" />
        </StackPanel>
      </Border>
    </Border>
  </Grid>
</Window>
