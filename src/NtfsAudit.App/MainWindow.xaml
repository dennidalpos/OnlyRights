<Window x:Class="NtfsAudit.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="NTFS Audit"
        Width="980"
        Height="640"
        MinWidth="800"
        MinHeight="480"
        FontFamily="Segoe UI, Microsoft YaHei UI, Microsoft JhengHei UI, Yu Gothic UI"
        Closing="MainWindow_OnClosing">
  <Window.Resources>
    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    <Style TargetType="FrameworkElement">
      <Setter Property="ToolTipService.InitialShowDelay" Value="250" />
      <Setter Property="ToolTipService.ShowDuration" Value="8000" />
      <Setter Property="ToolTipService.ShowOnDisabled" Value="True" />
    </Style>
    <Style TargetType="ToolTip">
      <Setter Property="Placement" Value="Mouse" />
      <Setter Property="FontSize" Value="12" />
      <Setter Property="Padding" Value="8,6" />
      <Setter Property="Background" Value="#FF263238" />
      <Setter Property="Foreground" Value="White" />
      <Setter Property="BorderBrush" Value="#FF37474F" />
      <Setter Property="BorderThickness" Value="1" />
    </Style>
    <Style x:Key="SectionHeaderText" TargetType="TextBlock">
      <Setter Property="FontSize" Value="16" />
      <Setter Property="FontWeight" Value="SemiBold" />
      <Setter Property="Foreground" Value="#FF1F1F1F" />
      <Setter Property="Margin" Value="0,0,0,8" />
    </Style>
    <Style x:Key="SubsectionHeaderText" TargetType="TextBlock">
      <Setter Property="FontSize" Value="13" />
      <Setter Property="FontWeight" Value="SemiBold" />
      <Setter Property="Foreground" Value="#FF424242" />
      <Setter Property="Margin" Value="0,6,0,4" />
    </Style>
    <Style x:Key="MicrocopyText" TargetType="TextBlock">
      <Setter Property="FontSize" Value="11" />
      <Setter Property="Foreground" Value="#FF616161" />
      <Setter Property="Margin" Value="0,2,0,6" />
    </Style>
    <Style x:Key="RightsRowStyle" TargetType="DataGridRow">
      <Style.Triggers>
        <DataTrigger Binding="{Binding IsDisabled}" Value="True">
          <Setter Property="TextBlock.TextDecorations" Value="Strikethrough" />
          <Setter Property="Foreground" Value="#FF9E9E9E" />
        </DataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasRead}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE3F2FD" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasList}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE3F2FD" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasReadAndExecute}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE3F2FD" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasWrite}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFE8F5E9" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasModify}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFFFF3E0" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding HasFullControl}" Value="True" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFF3E5F5" />
        </MultiDataTrigger>
        <MultiDataTrigger>
          <MultiDataTrigger.Conditions>
            <Condition Binding="{Binding DataContext.ColorizeRights, RelativeSource={RelativeSource AncestorType=DataGrid}}" Value="True" />
            <Condition Binding="{Binding AllowDeny}" Value="Deny" />
          </MultiDataTrigger.Conditions>
          <Setter Property="Background" Value="#FFFFEBEE" />
          <Setter Property="Foreground" Value="#FFB71C1C" />
        </MultiDataTrigger>
      </Style.Triggers>
    </Style>
    <Style x:Key="BadgeToolTipBorder" TargetType="Border">
      <Setter Property="ToolTipService.InitialShowDelay" Value="250" />
      <Setter Property="ToolTipService.ShowDuration" Value="8000" />
      <Setter Property="ToolTipService.ShowOnDisabled" Value="True" />
    </Style>
    <DataTemplate x:Key="PermissionBadgesTemplate">
      <StackPanel Orientation="Horizontal">
        <Border Padding="4,0" CornerRadius="2" Margin="0,0,4,0" ToolTip="{Binding HighestRightToolTip}">
          <Border.Style>
            <Style TargetType="Border" BasedOn="{StaticResource BadgeToolTipBorder}">
              <Setter Property="Visibility" Value="Collapsed" />
              <Setter Property="Background" Value="#FF2F80ED" />
              <Style.Triggers>
                <DataTrigger Binding="{Binding HighestRightKey}" Value="Full">
                  <Setter Property="Visibility" Value="Visible" />
                  <Setter Property="Background" Value="#FF9B51E0" />
                </DataTrigger>
                <DataTrigger Binding="{Binding HighestRightKey}" Value="Modify">
                  <Setter Property="Visibility" Value="Visible" />
                  <Setter Property="Background" Value="#FFF2994A" />
                </DataTrigger>
                <DataTrigger Binding="{Binding HighestRightKey}" Value="ReadAndExecute">
                  <Setter Property="Visibility" Value="Visible" />
                  <Setter Property="Background" Value="#FF2F80ED" />
                </DataTrigger>
                <DataTrigger Binding="{Binding HighestRightKey}" Value="Write">
                  <Setter Property="Visibility" Value="Visible" />
                  <Setter Property="Background" Value="#FF27AE60" />
                </DataTrigger>
                <DataTrigger Binding="{Binding HighestRightKey}" Value="List">
                  <Setter Property="Visibility" Value="Visible" />
                  <Setter Property="Background" Value="#FF2F80ED" />
                </DataTrigger>
                <DataTrigger Binding="{Binding HighestRightKey}" Value="Read">
                  <Setter Property="Visibility" Value="Visible" />
                  <Setter Property="Background" Value="#FF2F80ED" />
                </DataTrigger>
              </Style.Triggers>
            </Style>
          </Border.Style>
          <TextBlock Text="{Binding HighestRightLabel}" Foreground="White" FontSize="10" />
        </Border>
        <Border Background="#FF1976D2" Padding="2,0" CornerRadius="2" Margin="0,0,4,0" Visibility="{Binding IsInherited, Converter={StaticResource BooleanToVisibilityConverter}}" ToolTip="Ereditato" Style="{StaticResource BadgeToolTipBorder}">
          <TextBlock Text="I" Foreground="White" FontSize="10" />
        </Border>
        <Border Background="#FFC62828" Padding="2,0" CornerRadius="2" Margin="0,0,4,0" Visibility="{Binding IsInheritanceDisabled, Converter={StaticResource BooleanToVisibilityConverter}}" ToolTip="Protetto (ereditarietÃ  disabilitata)" Style="{StaticResource BadgeToolTipBorder}">
          <TextBlock Text="P" Foreground="White" FontSize="10" />
        </Border>
        <Border Background="#FFEB5757" Padding="2,0" CornerRadius="2" Margin="0,0,4,0" Visibility="{Binding IsExplicitDeny, Converter={StaticResource BooleanToVisibilityConverter}}" ToolTip="Accesso negato (Deny esplicito)" Style="{StaticResource BadgeToolTipBorder}">
          <TextBlock Text="D" Foreground="White" FontSize="10" />
        </Border>
      </StackPanel>
    </DataTemplate>
  </Window.Resources>
  <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
    <Grid x:Name="ContentGrid" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" IsEnabled="{Binding IsNotBusy}">
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto" />
        <RowDefinition Height="*" />
      </Grid.RowDefinitions>

      <Border Grid.Row="0" Padding="12" BorderBrush="#DDDDDD" BorderThickness="0,0,0,1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <Grid>
          <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
          </Grid.RowDefinitions>
          <Border Grid.Row="0" BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,0,0,8" Visibility="{Binding IsNotViewerMode, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
              <Button Margin="0,0,8,0" Padding="12,4" Content="Avvia analisi" Command="{Binding StartCommand}" IsEnabled="{Binding CanStart}" Background="#FF2E7D32" Foreground="White" />
              <Button Margin="0,0,8,0" Padding="12,4" Content="Stop" Command="{Binding StopCommand}" IsEnabled="{Binding CanStop}" Background="#FFC62828" Foreground="White" />
              <Button Margin="0,0,8,0" Padding="12,4" Content="Installa servizio Windows" Command="{Binding InstallServiceCommand}" Background="#FF6A1B9A" Foreground="White" />
              <Button Margin="0,0,8,0" Padding="12,4" Content="Disinstalla servizio Windows" Command="{Binding UninstallServiceCommand}" Background="#FF8E24AA" Foreground="White" />
              <Button Margin="0,0,8,0" Padding="12,4" Content="Esporta elenco permessi (Excel)" Command="{Binding ExportCommand}" IsEnabled="{Binding CanExport}" Background="#FF1565C0" Foreground="White" />
              <Button Margin="0,0,8,0" Padding="12,4" Content="Salva report completo (.ntaudit)" Command="{Binding ExportAnalysisCommand}" IsEnabled="{Binding CanExport}" Background="#FF1565C0" Foreground="White" />
              <Button Padding="12,4" Content="Import Analisi" Command="{Binding ImportAnalysisCommand}" IsEnabled="{Binding CanImportAnalysis}" Background="#FF616161" Foreground="White" />
            </StackPanel>
          </Border>

          <Border Grid.Row="0" BorderBrush="#DDDDDD" BorderThickness="1" Padding="8" Margin="0,0,0,8" Visibility="{Binding IsViewerMode, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel Orientation="Horizontal">
              <Button Padding="12,4" Content="Import Analisi" Command="{Binding ImportAnalysisCommand}" IsEnabled="{Binding CanImportAnalysis}" Background="#FF616161" Foreground="White" />
            </StackPanel>
          </Border>

          <Border Grid.Row="1" Background="#FFFFF3CD" BorderBrush="#FFFFEEBA" BorderThickness="1" CornerRadius="10" Padding="6,2"
                  HorizontalAlignment="Left"
                  Visibility="{Binding IsNotElevated, Converter={StaticResource BooleanToVisibilityConverter}}">
            <TextBlock Text="Non amministratore"
                       Foreground="#FF856404"
                       FontWeight="SemiBold" />
          </Border>
        </Grid>
      </Border>

      <Grid Grid.Row="1" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="320" />
          <ColumnDefinition Width="6" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="6" />
          <ColumnDefinition Width="320" />
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0" BorderBrush="#DDDDDD" BorderThickness="1" Padding="12" Margin="12,12,6,12" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <TextBlock Grid.Row="0" Text="Albero cartelle" Style="{StaticResource SectionHeaderText}" />
            <StackPanel Grid.Row="1" Margin="0,0,0,8">
              <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                <Button Margin="0,0,8,0" Padding="10,4" Content="Espandi tutto" IsEnabled="{Binding HasScanResult}" Click="ExpandTree_Click" />
                <Button Padding="10,4" Content="Comprimi tutto" IsEnabled="{Binding HasScanResult}" Click="CollapseTree_Click" />
              </StackPanel>
              <Expander Header="Legenda e filtri Tree" IsExpanded="False" IsEnabled="{Binding HasScanResult}">
                <StackPanel Margin="0,6,0,0">
                  <TextBlock Text="ðŸ”Ž Filtri Tree" Style="{StaticResource SubsectionHeaderText}" />
                  <WrapPanel Margin="0,0,0,4">
                    <StackPanel Orientation="Horizontal" Margin="0,0,10,4" ToolTip="Mostra o nasconde i nodi con permessi NTFS espliciti.">
                                            <Border Background="#FF00897B" Padding="2,0" CornerRadius="2" Margin="0,0,4,0"><TextBlock Text="N" Foreground="White" FontSize="10" /></Border>
                      <CheckBox Content="NTFS espliciti" IsChecked="{Binding TreeFilterExplicitOnly}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,10,4" ToolTip="Mostra o nasconde i nodi protetti (ereditarietÃ  disabilitata).">
                                            <Border Background="#FFC62828" Padding="2,0" CornerRadius="2" Margin="0,0,4,0"><TextBlock Text="P" Foreground="White" FontSize="10" /></Border>
                      <CheckBox Content="Protetto" IsChecked="{Binding TreeFilterInheritanceDisabledOnly}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,10,4" ToolTip="Mostra o nasconde i nodi con differenze ACL rispetto alla cartella padre immediata (confronto gerarchico).">
                                            <Border Background="#FF455A64" Padding="2,0" CornerRadius="2" Margin="0,0,4,0"><TextBlock Text="Î”" Foreground="White" FontSize="10" /></Border>
                      <CheckBox Content="Diff vs padre" IsChecked="{Binding TreeFilterDiffOnly}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,10,4" ToolTip="Mostra o nasconde i nodi con regole Deny esplicite.">
                                            <Border Background="#FFAD1457" Padding="2,0" CornerRadius="2" Margin="0,0,4,0"><TextBlock Text="D" Foreground="White" FontSize="10" /></Border>
                      <CheckBox Content="Deny espliciti" IsChecked="{Binding TreeFilterExplicitDenyOnly}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,10,4" ToolTip="Mostra o nasconde i nodi con differenze ACL rispetto alla baseline/policy attesa (confronto assoluto).">
                                            <Border Background="#FF455A64" Padding="2,0" CornerRadius="2" Margin="0,0,4,0"><TextBlock Text="B" Foreground="White" FontSize="10" /></Border>
                      <CheckBox Content="Mismatch baseline" IsChecked="{Binding TreeFilterBaselineMismatchOnly}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,10,4" ToolTip="Mostra o nasconde i nodi che contengono file analizzati.">
                                            <Border Background="#FF616161" Padding="2,0" CornerRadius="2" Margin="0,0,4,0"><TextBlock Text="F" Foreground="White" FontSize="10" /></Border>
                      <CheckBox Content="Con file" IsChecked="{Binding TreeFilterFilesOnly}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,10,4" ToolTip="Mostra o nasconde i nodi di tipo cartella.">
                                            <Border Background="#FF455A64" Padding="2,0" CornerRadius="2" Margin="0,0,4,0"><TextBlock Text="C" Foreground="White" FontSize="10" /></Border>
                      <CheckBox Content="Solo cartelle" IsChecked="{Binding TreeFilterFoldersOnly}" />
                    </StackPanel>
                  </WrapPanel>
                  <TextBlock Text="Î” = confronto con la cartella padre | B = confronto con baseline/policy attesa" Style="{StaticResource MicrocopyText}" />
                  <Button Content="Reset filtri tree" Width="140" Margin="0,0,0,8" Command="{Binding ResetTreeFiltersCommand}" />
                                  </StackPanel>
              </Expander>
            </StackPanel>
            <TreeView x:Name="FolderTreeView" Grid.Row="2" ItemsSource="{Binding FolderTree}" SelectedItemChanged="TreeView_OnSelectedItemChanged" VirtualizingStackPanel.IsVirtualizing="True" VirtualizingStackPanel.VirtualizationMode="Recycling">
              <TreeView.ItemContainerStyle>
                <Style TargetType="TreeViewItem">
                  <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                  <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
                  <Setter Property="Background" Value="Transparent" />
                  <Setter Property="Foreground" Value="#FF212121" />
                  <Style.Triggers>
                    <Trigger Property="IsSelected" Value="True">
                      <Setter Property="Background" Value="#FFBBDEFB" />
                      <Setter Property="Foreground" Value="#FF0D47A1" />
                      <Setter Property="FontWeight" Value="SemiBold" />
                    </Trigger>
                  </Style.Triggers>
                </Style>
              </TreeView.ItemContainerStyle>
              <TreeView.ItemTemplate>
                <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ðŸ“" Margin="0,0,6,0" />
                    <TextBlock Text="{Binding DisplayName}" />
                    <Border Background="#FFC62828" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" ToolTip="Protetto (ereditarietÃ  disabilitata)"><Border.Style>
                        <Style TargetType="Border" BasedOn="{StaticResource BadgeToolTipBorder}">
                          <Setter Property="Visibility" Value="Collapsed" />
                          <Style.Triggers>
                            <MultiDataTrigger>
                              <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding IsProtected}" Value="True" />
                                <Condition Binding="{Binding DataContext.TreeFilterInheritanceDisabledOnly, RelativeSource={RelativeSource AncestorType=TreeView}}" Value="True" />
                              </MultiDataTrigger.Conditions>
                              <Setter Property="Visibility" Value="Visible" />
                            </MultiDataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <TextBlock Text="P" Foreground="White" FontSize="10" />
                    </Border>
                    <Border Background="#FF455A64" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" ToolTip="Differenze rispetto alla cartella padre">
                      <Border.Style>
                        <Style TargetType="Border" BasedOn="{StaticResource BadgeToolTipBorder}">
                          <Setter Property="Visibility" Value="Collapsed" />
                          <Style.Triggers>
                            <MultiDataTrigger>
                              <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding HasDiff}" Value="True" />
                                <Condition Binding="{Binding DataContext.TreeFilterDiffOnly, RelativeSource={RelativeSource AncestorType=TreeView}}" Value="True" />
                              </MultiDataTrigger.Conditions>
                              <Setter Property="Visibility" Value="Visible" />
                            </MultiDataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <TextBlock Text="{Binding DiffLabel}" Foreground="White" FontSize="10" />
                    </Border>
                    <Border Background="#FFAD1457" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" ToolTip="Accesso negato (Deny espliciti)">
                      <Border.Style>
                        <Style TargetType="Border" BasedOn="{StaticResource BadgeToolTipBorder}">
                          <Setter Property="Visibility" Value="Collapsed" />
                          <Style.Triggers>
                            <MultiDataTrigger>
                              <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding HasDenyExplicit}" Value="True" />
                                <Condition Binding="{Binding DataContext.TreeFilterExplicitDenyOnly, RelativeSource={RelativeSource AncestorType=TreeView}}" Value="True" />
                              </MultiDataTrigger.Conditions>
                              <Setter Property="Visibility" Value="Visible" />
                            </MultiDataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <TextBlock Text="{Binding DenyExplicitLabel}" Foreground="White" FontSize="10" />
                    </Border>
                    <Border Background="#FF455A64" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" ToolTip="Differenze rispetto alla baseline">
                      <Border.Style>
                        <Style TargetType="Border" BasedOn="{StaticResource BadgeToolTipBorder}">
                          <Setter Property="Visibility" Value="Collapsed" />
                          <Style.Triggers>
                            <MultiDataTrigger>
                              <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding HasBaselineMismatch}" Value="True" />
                                <Condition Binding="{Binding DataContext.TreeFilterBaselineMismatchOnly, RelativeSource={RelativeSource AncestorType=TreeView}}" Value="True" />
                              </MultiDataTrigger.Conditions>
                              <Setter Property="Visibility" Value="Visible" />
                            </MultiDataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <TextBlock Text="{Binding BaselineMismatchLabel}" Foreground="White" FontSize="10" />
                    </Border>
                    <Border Background="#FF00897B" Padding="2,0" CornerRadius="2" Margin="6,0,0,0" VerticalAlignment="Center" ToolTip="Permessi NTFS espliciti">
                      <Border.Style>
                        <Style TargetType="Border" BasedOn="{StaticResource BadgeToolTipBorder}">
                          <Setter Property="Visibility" Value="Collapsed" />
                          <Style.Triggers>
                            <MultiDataTrigger>
                              <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding HasExplicitNtfs}" Value="True" />
                                <Condition Binding="{Binding DataContext.TreeFilterExplicitOnly, RelativeSource={RelativeSource AncestorType=TreeView}}" Value="True" />
                              </MultiDataTrigger.Conditions>
                              <Setter Property="Visibility" Value="Visible" />
                            </MultiDataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <TextBlock Text="{Binding ExplicitNtfsLabel}" Foreground="White" FontSize="10" />
                    </Border>
                  </StackPanel>
                </HierarchicalDataTemplate>
              </TreeView.ItemTemplate>
            </TreeView>
          </Grid>
        </Border>

        <GridSplitter Grid.Column="1" Width="6" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="#FFE0E0E0" />

        <Border Grid.Column="2" BorderBrush="#DDDDDD" BorderThickness="1" Padding="12" Margin="6,12" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <StackPanel Grid.Row="0">
              <TextBlock Text="Risultati" Style="{StaticResource SectionHeaderText}" />
            </StackPanel>
            <StackPanel Grid.Row="1" Margin="0,8,0,8" IsEnabled="{Binding HasScanResult}">
              <TextBlock Text="ðŸ·ï¸ Legenda diritti" Style="{StaticResource SubsectionHeaderText}" />
              <WrapPanel Margin="0,0,0,6">
                <Border Background="#FF2F80ED" Padding="4,2" CornerRadius="2" Margin="0,0,6,4" ToolTip="Permesso di lettura" Style="{StaticResource BadgeToolTipBorder}">
                  <TextBlock Text="ðŸ‘ Read" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FF2F80ED" Padding="4,2" CornerRadius="2" Margin="0,0,6,4" ToolTip="Visualizza elenco contenuti" Style="{StaticResource BadgeToolTipBorder}">
                  <TextBlock Text="ðŸ“„ List" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FF2F80ED" Padding="4,2" CornerRadius="2" Margin="0,0,6,4" ToolTip="Lettura ed esecuzione" Style="{StaticResource BadgeToolTipBorder}">
                  <TextBlock Text="âš™ R&amp;E" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FF27AE60" Padding="4,2" CornerRadius="2" Margin="0,0,6,4" ToolTip="Scrittura" Style="{StaticResource BadgeToolTipBorder}">
                  <TextBlock Text="âœ Write" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FFF2994A" Padding="4,2" CornerRadius="2" Margin="0,0,6,4" ToolTip="Modifica" Style="{StaticResource BadgeToolTipBorder}">
                  <TextBlock Text="ðŸ›  Modify" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FF9B51E0" Padding="4,2" CornerRadius="2" Margin="0,0,6,4" ToolTip="Controllo completo" Style="{StaticResource BadgeToolTipBorder}">
                  <TextBlock Text="ðŸ‘‘ Full" Foreground="White" FontSize="10" />
                </Border>
                <Border Background="#FFEB5757" Padding="4,2" CornerRadius="2" Margin="0,0,6,4" ToolTip="Accesso negato (Deny)" Style="{StaticResource BadgeToolTipBorder}">
                  <TextBlock Text="â›” Deny" Foreground="White" FontSize="10" />
                </Border>
              </WrapPanel>
              <TextBlock Text="Cartella trattata" FontSize="11" Foreground="#FF546E7A" FontWeight="SemiBold" />
              <TextBlock Text="{Binding SelectedFolderName}" FontWeight="SemiBold" FontSize="13" Foreground="#FF0D47A1" TextTrimming="CharacterEllipsis" />
              <TextBlock Text="{Binding SelectedFolderPath}" FontSize="11" Foreground="#FF546E7A" TextTrimming="CharacterEllipsis" Margin="0,0,0,6" />

              <Expander Header="Filtri persistenti" IsExpanded="False" BorderBrush="#DDDDDD" BorderThickness="1" Padding="10">
                <StackPanel>
                  <TextBlock Text="Ricerca ACL / Gruppo / Utente" Style="{StaticResource SubsectionHeaderText}" />
                  <Grid Margin="0,0,0,6">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto" />
                      <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="Filtro:" VerticalAlignment="Center" Margin="0,0,6,0" />
                    <TextBox Grid.Column="1" Height="26" MinWidth="220" Text="{Binding AclFilter, UpdateSourceTrigger=PropertyChanged}" />
                  </Grid>
                  <TextBlock Text="Permessi" Style="{StaticResource SubsectionHeaderText}" />
                  <WrapPanel Margin="0,0,0,4">
                    <CheckBox Margin="0,0,12,6" Content="Colora per diritto" IsChecked="{Binding ColorizeRights}" />
                    <CheckBox Margin="0,0,12,6" Content="Allow" IsChecked="{Binding ShowAllow}" />
                    <CheckBox Margin="0,0,12,6" Content="Deny" IsChecked="{Binding ShowDeny}" />
                    <CheckBox Margin="0,0,12,6" Content="Ereditato" IsChecked="{Binding ShowInherited}" />
                    <CheckBox Margin="0,0,12,6" Content="Esplicito" IsChecked="{Binding ShowExplicit}" />
                    <CheckBox Margin="0,0,12,6" Content="Protetto" IsChecked="{Binding ShowProtected}" />
                    <CheckBox Margin="0,0,12,6" Content="Disabilitato" IsChecked="{Binding ShowDisabled}" />
                  </WrapPanel>
                  <TextBlock Text="IdentitÃ " Style="{StaticResource SubsectionHeaderText}" />
                  <WrapPanel Margin="0,0,0,4">
                    <CheckBox Margin="0,0,12,6" Content="Everyone" IsChecked="{Binding ShowEveryone}" />
                    <CheckBox Margin="0,0,12,6" Content="Authenticated Users" IsChecked="{Binding ShowAuthenticatedUsers}" />
                    <CheckBox Margin="0,0,12,6" Content="Utenti di servizio" IsChecked="{Binding ShowServiceAccounts}" />
                    <CheckBox Margin="0,0,12,6" Content="Admin" IsChecked="{Binding ShowAdminAccounts}" />
                    <CheckBox Margin="0,0,12,6" Content="Altri" IsChecked="{Binding ShowOtherPrincipals}" />
                  </WrapPanel>
                </StackPanel>
              </Expander>
            </StackPanel>
            <TabControl Grid.Row="2" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
              <TabItem Header="Permessi Gruppi" ToolTip="Vista permessi dei gruppi con badge, diritti e metadati ACL.">
                <DataGrid ToolTip="Risultati filtrati dei permessi gruppo." ItemsSource="{Binding FilteredGroupEntries}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ColumnWidth="SizeToCells"
                          MinColumnWidth="80"
                          MouseDoubleClick="GroupEntries_OnMouseDoubleClick"
                          RowStyle="{StaticResource RightsRowStyle}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                  <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Badge" CellTemplate="{StaticResource PermissionBadgesTemplate}" />
                    <DataGridTextColumn Header="Gruppo" Binding="{Binding PrincipalName}" />
                    <DataGridTextColumn Header="Owner" Binding="{Binding Owner}" />
                    <DataGridCheckBoxColumn Header="Disabilitato" Binding="{Binding IsDisabled, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Ereditato" Binding="{Binding IsInherited, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Full" Binding="{Binding HasFullControl, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Modify" Binding="{Binding HasModify, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="R&amp;E" Binding="{Binding HasReadAndExecute, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="List" Binding="{Binding HasList, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Read" Binding="{Binding HasRead, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Write" Binding="{Binding HasWrite, Mode=OneWay}" />
                    <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" />
                    <DataGridTextColumn Header="Risorsa" Binding="{Binding ResourceType}" />
                    <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" />
                    <DataGridTextColumn Header="Effective Access" Binding="{Binding EffectiveRightsSummary}" />
                    <DataGridTextColumn Header="Rischio" Binding="{Binding RiskLevel}" />
                    <DataGridTextColumn Header="SACL/Audit" Binding="{Binding AuditSummary}" />
                    <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" />
                    <DataGridTextColumn Header="Inheritance" Binding="{Binding InheritanceFlags}" />
                    <DataGridTextColumn Header="Propagation" Binding="{Binding PropagationFlags}" />
                  </DataGrid.Columns>
                </DataGrid>
              </TabItem>
              <TabItem Header="Permessi Utenti" ToolTip="Vista permessi degli utenti con badge, diritti e metadati ACL.">
                <DataGrid ToolTip="Risultati filtrati dei permessi utente." ItemsSource="{Binding FilteredUserEntries}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ColumnWidth="SizeToCells"
                          MinColumnWidth="80"
                          MouseDoubleClick="UserEntries_OnMouseDoubleClick"
                          RowStyle="{StaticResource RightsRowStyle}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                  <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Badge" CellTemplate="{StaticResource PermissionBadgesTemplate}" />
                    <DataGridTextColumn Header="Utente" Binding="{Binding PrincipalName}" />
                    <DataGridTextColumn Header="Owner" Binding="{Binding Owner}" />
                    <DataGridCheckBoxColumn Header="Disabilitato" Binding="{Binding IsDisabled, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Ereditato" Binding="{Binding IsInherited, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Full" Binding="{Binding HasFullControl, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Modify" Binding="{Binding HasModify, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="R&amp;E" Binding="{Binding HasReadAndExecute, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="List" Binding="{Binding HasList, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Read" Binding="{Binding HasRead, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Write" Binding="{Binding HasWrite, Mode=OneWay}" />
                    <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" />
                    <DataGridTextColumn Header="Risorsa" Binding="{Binding ResourceType}" />
                    <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" />
                    <DataGridTextColumn Header="Effective Access" Binding="{Binding EffectiveRightsSummary}" />
                    <DataGridTextColumn Header="Rischio" Binding="{Binding RiskLevel}" />
                    <DataGridTextColumn Header="SACL/Audit" Binding="{Binding AuditSummary}" />
                    <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" />
                    <DataGridTextColumn Header="Inheritance" Binding="{Binding InheritanceFlags}" />
                    <DataGridTextColumn Header="Propagation" Binding="{Binding PropagationFlags}" />
                  </DataGrid.Columns>
                </DataGrid>
              </TabItem>
              <TabItem Header="Dettaglio ACL" ToolTip="Vista completa ACL (utenti, gruppi, share ed effective).">
                <DataGrid ToolTip="Dettaglio ACL completo del nodo selezionato." ItemsSource="{Binding FilteredAllEntries}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ColumnWidth="SizeToCells"
                          MinColumnWidth="80"
                          RowStyle="{StaticResource RightsRowStyle}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                  <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Badge" CellTemplate="{StaticResource PermissionBadgesTemplate}" />
                    <DataGridTextColumn Header="Principal" Binding="{Binding PrincipalName}" />
                    <DataGridTextColumn Header="Owner" Binding="{Binding Owner}" />
                    <DataGridCheckBoxColumn Header="Disabilitato" Binding="{Binding IsDisabled, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Ereditato" Binding="{Binding IsInherited, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Full" Binding="{Binding HasFullControl, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Modify" Binding="{Binding HasModify, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="R&amp;E" Binding="{Binding HasReadAndExecute, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="List" Binding="{Binding HasList, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Read" Binding="{Binding HasRead, Mode=OneWay}" />
                    <DataGridCheckBoxColumn Header="Write" Binding="{Binding HasWrite, Mode=OneWay}" />
                    <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" />
                    <DataGridTextColumn Header="Tipo" Binding="{Binding PrincipalType}" />
                    <DataGridTextColumn Header="Risorsa" Binding="{Binding ResourceType}" />
                    <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" />
                    <DataGridTextColumn Header="Effective Access" Binding="{Binding EffectiveRightsSummary}" />
                    <DataGridTextColumn Header="Rischio" Binding="{Binding RiskLevel}" />
                    <DataGridTextColumn Header="SACL/Audit" Binding="{Binding AuditSummary}" />
                    <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" />
                    <DataGridTextColumn Header="Inheritance" Binding="{Binding InheritanceFlags}" />
                    <DataGridTextColumn Header="Propagation" Binding="{Binding PropagationFlags}" />
                  </DataGrid.Columns>
                </DataGrid>
              </TabItem>
              <TabItem Header="Share" ToolTip="Vista dei permessi Share SMB rilevati durante la scansione.">
                <DataGrid ToolTip="Permessi Share SMB del nodo selezionato." ItemsSource="{Binding FilteredShareEntries}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ColumnWidth="SizeToCells"
                          MinColumnWidth="80"
                          RowStyle="{StaticResource RightsRowStyle}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                  <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Badge" CellTemplate="{StaticResource PermissionBadgesTemplate}" />
                    <DataGridTextColumn Header="Principal" Binding="{Binding PrincipalName}" />
                    <DataGridTextColumn Header="Owner" Binding="{Binding Owner}" />
                    <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" />
                    <DataGridTextColumn Header="Server" Binding="{Binding ShareServer}" />
                    <DataGridTextColumn Header="Share" Binding="{Binding ShareName}" />
                    <DataGridTextColumn Header="Allow/Deny" Binding="{Binding AllowDeny}" />
                    <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" />
                    <DataGridTextColumn Header="SACL/Audit" Binding="{Binding AuditSummary}" />
                  </DataGrid.Columns>
                </DataGrid>
              </TabItem>
              <TabItem Header="Effective Access" ToolTip="Vista accesso effettivo calcolato da NTFS + Share.">
                <DataGrid ToolTip="Accesso effettivo combinato NTFS/Share del nodo selezionato." ItemsSource="{Binding FilteredEffectiveEntries}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          EnableRowVirtualization="True"
                          EnableColumnVirtualization="True"
                          ScrollViewer.CanContentScroll="True"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          ColumnWidth="SizeToCells"
                          MinColumnWidth="80"
                          RowStyle="{StaticResource RightsRowStyle}"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch">
                  <DataGrid.Columns>
                    <DataGridTemplateColumn Header="Badge" CellTemplate="{StaticResource PermissionBadgesTemplate}" />
                    <DataGridTextColumn Header="Principal" Binding="{Binding PrincipalName}" />
                    <DataGridTextColumn Header="Owner" Binding="{Binding Owner}" />
                    <DataGridTextColumn Header="SID" Binding="{Binding PrincipalSid}" />
                    <DataGridTextColumn Header="Effective" Binding="{Binding EffectiveRightsSummary}" />
                    <DataGridTextColumn Header="NTFS Mask" Binding="{Binding NtfsRightsMask}" />
                    <DataGridTextColumn Header="Share Mask" Binding="{Binding ShareRightsMask}" />
                    <DataGridTextColumn Header="Depth" Binding="{Binding Depth}" />
                  </DataGrid.Columns>
                </DataGrid>
              </TabItem>
              <TabItem Header="Info Permessi" ToolTip="Riepilogo cartella e autorizzazioni in stile sicurezza/avanzate Windows.">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                  <StackPanel Margin="8">
                    <TextBlock Text="Oggetto" Style="{StaticResource SubsectionHeaderText}" />
                    <Border Background="#FFF5F5F5" BorderBrush="#FFE0E0E0" BorderThickness="1" CornerRadius="3" Padding="8" Margin="0,0,0,8">
                      <TextBlock Text="{Binding SelectedFolderPath}" FontWeight="SemiBold" TextWrapping="Wrap" />
                    </Border>

                    <TextBlock Text="Sicurezza avanzata" Style="{StaticResource SubsectionHeaderText}" />
                    <Border BorderBrush="#FFE0E0E0" BorderThickness="1" CornerRadius="3" Padding="8" Margin="0,0,0,6">
                      <Border.Style>
                        <Style TargetType="Border">
                          <Setter Property="Background" Value="#FFE8F5E9" />
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedOwnerSummary}" Value="-">
                              <Setter Property="Background" Value="#FFFFEBEE" />
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <TextBlock Text="{Binding SelectedOwnerSummary, StringFormat=Owner: {0}}" />
                    </Border>

                    <Border BorderBrush="#FFE0E0E0" BorderThickness="1" CornerRadius="3" Padding="8" Margin="0,0,0,10">
                      <Border.Style>
                        <Style TargetType="Border">
                          <Setter Property="Background" Value="#FFE8F5E9" />
                          <Style.Triggers>
                            <DataTrigger Binding="{Binding SelectedInheritanceSummary}" Value="EreditarietÃ  disabilitata">
                              <Setter Property="Background" Value="#FFFFEBEE" />
                            </DataTrigger>
                          </Style.Triggers>
                        </Style>
                      </Border.Style>
                      <TextBlock Text="{Binding SelectedInheritanceSummary}" />
                    </Border>

                    <TextBlock Text="Riepilogo autorizzazioni" Style="{StaticResource SubsectionHeaderText}" />
                    <WrapPanel>
                      <Border Background="#FFE3F2FD" BorderBrush="#FFBBDEFB" BorderThickness="1" CornerRadius="3" Padding="8,6" Margin="0,0,8,8">
                        <TextBlock Text="{Binding SelectedTotalAceCount, StringFormat=Totali: {0}}" />
                      </Border>
                      <Border BorderBrush="#FFBBDEFB" BorderThickness="1" CornerRadius="3" Padding="8,6" Margin="0,0,8,8">
                        <Border.Style>
                          <Style TargetType="Border">
                            <Setter Property="Background" Value="#FFE3F2FD" />
                            <Style.Triggers>
                              <DataTrigger Binding="{Binding SelectedExplicitAceCount}" Value="0">
                                <Setter Property="Background" Value="#FFF5F5F5" />
                                <Setter Property="BorderBrush" Value="#FFE0E0E0" />
                              </DataTrigger>
                            </Style.Triggers>
                          </Style>
                        </Border.Style>
                        <TextBlock Text="{Binding SelectedExplicitAceCount, StringFormat=Esplicite: {0}}" />
                      </Border>
                      <Border BorderBrush="#FFC8E6C9" BorderThickness="1" CornerRadius="3" Padding="8,6" Margin="0,0,8,8">
                        <Border.Style>
                          <Style TargetType="Border">
                            <Setter Property="Background" Value="#FFE8F5E9" />
                            <Style.Triggers>
                              <DataTrigger Binding="{Binding SelectedInheritedAceCount}" Value="0">
                                <Setter Property="Background" Value="#FFFFF8E1" />
                                <Setter Property="BorderBrush" Value="#FFFFE082" />
                              </DataTrigger>
                            </Style.Triggers>
                          </Style>
                        </Border.Style>
                        <TextBlock Text="{Binding SelectedInheritedAceCount, StringFormat=Ereditate: {0}}" />
                      </Border>
                      <Border BorderBrush="#FFFFCDD2" BorderThickness="1" CornerRadius="3" Padding="8,6" Margin="0,0,8,8">
                        <Border.Style>
                          <Style TargetType="Border">
                            <Setter Property="Background" Value="#FFFFEBEE" />
                            <Style.Triggers>
                              <DataTrigger Binding="{Binding SelectedDenyAceCount}" Value="0">
                                <Setter Property="Background" Value="#FFF5F5F5" />
                                <Setter Property="BorderBrush" Value="#FFE0E0E0" />
                              </DataTrigger>
                            </Style.Triggers>
                          </Style>
                        </Border.Style>
                        <TextBlock Text="{Binding SelectedDenyAceCount, StringFormat=Deny: {0}}" />
                      </Border>
                    </WrapPanel>
                  </StackPanel>
                </ScrollViewer>
              </TabItem>
              <TabItem Header="Errori" ToolTip="Errori raccolti durante scansione e import/export.">
                <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
                  <DataGrid ToolTip="Elenco errori (path, tipo e messaggio)." ItemsSource="{Binding FilteredErrors}"
                            AutoGenerateColumns="False"
                            IsReadOnly="True"
                            EnableRowVirtualization="True"
                            EnableColumnVirtualization="True"
                            ScrollViewer.CanContentScroll="True"
                            ScrollViewer.HorizontalScrollBarVisibility="Auto"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            ColumnWidth="SizeToCells"
                            MinColumnWidth="80"
                            HorizontalAlignment="Stretch"
                            VerticalAlignment="Stretch">
                    <DataGrid.Columns>
                      <DataGridTextColumn Header="Path" Binding="{Binding Path}" />
                      <DataGridTextColumn Header="Tipo" Binding="{Binding ErrorType}" />
                      <DataGridTextColumn Header="Messaggio" Binding="{Binding Message}" />
                    </DataGrid.Columns>
                  </DataGrid>
                </Grid>
              </TabItem>
            </TabControl>
          </Grid>
        </Border>

        <GridSplitter Grid.Column="3" Width="6" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="#FFE0E0E0" />

        <Border Grid.Column="4" BorderBrush="#DDDDDD" BorderThickness="1" Padding="12" Margin="6,12,12,12" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
          <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel>
              <GroupBox Header="Stato scansione" BorderBrush="#DDDDDD" BorderThickness="1" Padding="10">
                <StackPanel>
                  <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                    <Border Width="14" Height="14" Background="{Binding StatusBrush}" CornerRadius="2" Margin="0,0,6,0" />
                    <TextBlock Text="{Binding StatusText}" FontWeight="SemiBold" VerticalAlignment="Center" />
                  </StackPanel>
                  <Border Background="{Binding CurrentPathBackground}" Padding="6" CornerRadius="4" Margin="0,0,0,8">
                    <TextBlock Text="{Binding CurrentPathText}" TextTrimming="CharacterEllipsis" />
                  </Border>
                  <WrapPanel Margin="0,0,0,6">
                    <Border Padding="6,4" CornerRadius="4" Margin="0,0,8,6" Background="#FFE8F5E9">
                      <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Cartelle analizzate: " VerticalAlignment="Center" />
                        <TextBlock Text="{Binding ProcessedCount}" VerticalAlignment="Center" />
                      </StackPanel>
                    </Border>
                    <Border Padding="6,4" CornerRadius="4" Margin="0,0,8,6" Background="#FFE3F2FD">
                      <StackPanel Orientation="Horizontal">
                        <TextBlock Text="File analizzati: " VerticalAlignment="Center" />
                        <TextBlock Text="{Binding ProcessedFilesCount}" VerticalAlignment="Center" />
                      </StackPanel>
                    </Border>
                    <Border Padding="6,4" CornerRadius="4" Margin="0,0,8,6" Background="#FFFFEBEE">
                      <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Errori: " VerticalAlignment="Center" />
                        <TextBlock Text="{Binding ErrorCount}" VerticalAlignment="Center" />
                      </StackPanel>
                    </Border>
                    <Border Padding="6,4" CornerRadius="4" Margin="0,0,8,6" Background="#FFF5F5F5">
                      <StackPanel Orientation="Horizontal">
                        <TextBlock Text="Tempo: " VerticalAlignment="Center" />
                        <TextBlock Text="{Binding ElapsedText}" VerticalAlignment="Center" />
                      </StackPanel>
                    </Border>
                  </WrapPanel>
                </StackPanel>
              </GroupBox>

              <GroupBox Header="Scansione" BorderBrush="#DDDDDD" BorderThickness="1" Padding="10" Margin="0,10,0,0" IsEnabled="{Binding IsScanConfigEnabled}" Visibility="{Binding IsNotViewerMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel>
                  <TextBlock Text="Cartelle da scansionare" Style="{StaticResource SubsectionHeaderText}" />
                  <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto" />
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <Button Grid.Column="0" Margin="0,0,8,0" Padding="10,4" Content="Sfoglia..." Command="{Binding BrowseCommand}" />
                    <TextBox Grid.Column="1" Height="26" VerticalAlignment="Center" MinWidth="160" Text="{Binding RootPath, UpdateSourceTrigger=PropertyChanged}" />
                    <Button Grid.Column="2" Margin="8,0,0,0" Padding="10,4" Content="Aggiungi" Command="{Binding AddScanRootCommand}" />
                  </Grid>
                  <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="*" />
                      <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <ListBox Grid.Column="0" Height="90" ItemsSource="{Binding ScanRoots}" SelectedItem="{Binding SelectedScanRoot}" />
                    <Button Grid.Column="1" Margin="8,0,0,0" Padding="10,4" Content="Rimuovi" VerticalAlignment="Top" Command="{Binding RemoveScanRootCommand}" />
                  </Grid>
                  <Grid Margin="0,0,0,6" Visibility="{Binding HasSelectedScanRootDfsTargets, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto" />
                      <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="Target DFS cartella selezionata" VerticalAlignment="Center" Margin="0,0,6,0" />
                    <ComboBox Grid.Column="1"
                              Height="24"
                              Background="#FFE3F2FD"
                              ItemsSource="{Binding SelectedScanRootDfsTargets}"
                              SelectedItem="{Binding SelectedScanRootDfsTarget, UpdateSourceTrigger=PropertyChanged}" />
                  </Grid>
                  <TextBlock Text="Output report .ntaudit" Style="{StaticResource SubsectionHeaderText}" />
                  <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="Auto" />
                      <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Button Grid.Column="0" Margin="0,0,8,0" Padding="10,4" Content="Sfoglia..." Command="{Binding BrowseOutputDirectoryCommand}" />
                    <TextBox Grid.Column="1" Height="26" VerticalAlignment="Center" MinWidth="160" Text="{Binding AuditOutputDirectory, UpdateSourceTrigger=PropertyChanged}" />
                  </Grid>
                  <CheckBox Margin="0,0,0,6" Content="Esegui tramite servizio Windows (cerca NtfsAudit.Service.exe / .dll)" IsChecked="{Binding UseWindowsServiceMode}" />
                  <Expander Header="Opzioni principali" IsExpanded="True">
                    <StackPanel Margin="0,6,0,0">
                      <Grid Margin="0,0,0,6">
                        <Grid.ColumnDefinitions>
                          <ColumnDefinition Width="Auto" />
                          <ColumnDefinition Width="Auto" />
                          <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="ProfonditÃ " VerticalAlignment="Center" Margin="0,0,6,0" />
                        <TextBox Grid.Column="1" Width="60" Height="24" Text="{Binding MaxDepth}" IsEnabled="{Binding IsMaxDepthEnabled}" Margin="0,0,12,0" />
                        <CheckBox Grid.Column="2" Content="Analizza tutte le sottocartelle" IsChecked="{Binding ScanAllDepths}" />
                      </Grid>
                      <CheckBox Content="Includi permessi ereditati" IsChecked="{Binding IncludeInherited}" />
                    </StackPanel>
                  </Expander>
                </StackPanel>
              </GroupBox>

              <GroupBox Header="Opzioni" BorderBrush="#DDDDDD" BorderThickness="1" Padding="10" Margin="0,10,0,0" IsEnabled="{Binding IsScanConfigEnabled}" Visibility="{Binding IsNotViewerMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel>
                  <TextBlock Text="IdentitÃ " Style="{StaticResource SubsectionHeaderText}" />
                  <CheckBox Margin="0,0,0,4" Content="Risolvi identitÃ " IsChecked="{Binding ResolveIdentities}" />
                  <TextBlock Text="Aumenta accuratezza, puÃ² impattare performance." Style="{StaticResource MicrocopyText}" />
                  <CheckBox Margin="0,0,0,4" Content="Espandi gruppi annidati" IsChecked="{Binding ExpandGroups}" IsEnabled="{Binding IsExpandGroupsEnabled}" />
                  <CheckBox Margin="0,0,0,4" Content="Usa PowerShell per AD" IsChecked="{Binding UsePowerShell}" IsEnabled="{Binding IsIdentityOptionsEnabled}" />
                  <Expander Header="Opzioni avanzate (per amministratori)" IsExpanded="False" Margin="0,8,0,0">
                    <StackPanel Margin="0,6,0,0">
                      <CheckBox Margin="0,0,0,4" Content="Abilita audit avanzato" IsChecked="{Binding EnableAdvancedAudit}" />
                      <StackPanel Margin="0,4,0,0" IsEnabled="{Binding IsAdvancedAuditEnabled}">
                      <CheckBox Margin="0,0,0,4" Content="Calcola Effective Access" IsChecked="{Binding ComputeEffectiveAccess}" />
                      <CheckBox Margin="0,0,0,4" Content="Leggi permessi Share (SMB)" IsChecked="{Binding IncludeSharePermissions}" />
                      <CheckBox Margin="0,0,0,4" Content="Scansiona file" IsChecked="{Binding IncludeFiles}" />
                      <CheckBox Margin="0,0,0,4" Content="Leggi Owner e SACL" IsChecked="{Binding ReadOwnerAndSacl}" />
                      <CheckBox Content="Confronta con baseline/policy attese" IsChecked="{Binding CompareBaseline}" />
                      </StackPanel>
                    </StackPanel>
                  </Expander>
                  <TextBlock Text="Esclusioni" Style="{StaticResource SubsectionHeaderText}" />
                  <CheckBox Margin="0,0,0,4" Content="Escludi utenti di servizio" IsChecked="{Binding ExcludeServiceAccounts}" IsEnabled="{Binding IsIdentityOptionsEnabled}" />
                  <CheckBox Content="Escludi utenti admin" IsChecked="{Binding ExcludeAdminAccounts}" IsEnabled="{Binding IsIdentityOptionsEnabled}" />
                </StackPanel>
              </GroupBox>
            </StackPanel>
          </ScrollViewer>
        </Border>
      </Grid>
    </Grid>
    <Border Background="#80000000" Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}" HorizontalAlignment="Stretch" VerticalAlignment="Stretch">
      <Border Background="White" Padding="24" CornerRadius="6" HorizontalAlignment="Center" VerticalAlignment="Center">
        <StackPanel>
          <TextBlock Text="Operazione in corso..." FontWeight="SemiBold" Margin="0,0,0,12" HorizontalAlignment="Center" />
          <ProgressBar Width="240" Height="16" IsIndeterminate="True" />
        </StackPanel>
      </Border>
    </Border>
  </Grid>
</Window>
